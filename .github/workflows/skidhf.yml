name: Extract Portfolio Zip

on:
  push:
    paths:
      - 'sahrilcode-sahrilmodzz-portofolio-bee1e19.zip'
  workflow_dispatch:
    inputs:
      zip_path:
        description: 'Path file .zip (opsional)'
        required: false
        default: 'sahrilcode-sahrilmodzz-portofolio-bee1e19.zip'

permissions:
  contents: write

jobs:
  extract:
    runs-on: ubuntu-latest
    env:
      ZIP_PATH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.zip_path || 'sahrilcode-sahrilmodzz-portofolio-bee1e19.zip' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify ZIP presence
        run: |
          echo "ZIP_PATH=${ZIP_PATH}"
          if [ ! -f "${ZIP_PATH}" ]; then
            echo "❌ Zip tidak ditemukan: ${ZIP_PATH}"
            exit 1
          fi
          echo "✅ Found: ${ZIP_PATH}"

      # (Opsional) bersihkan workspace selain .git & .github & zip
      # - name: Clean workspace (keep .git, .github, and zip)
      #   run: |
      #     shopt -s extglob dotglob
      #     rm -rf !(.git|.github|${ZIP_PATH})

      - name: Install unzip & extract
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip
          rm -rf extracted
          mkdir -p extracted
          unzip -q "${ZIP_PATH}" -d extracted

      - name: Move extracted content to repo root
        shell: bash
        run: |
          shopt -s dotglob
          roots=(extracted/*)
          if [ ${#roots[@]} -eq 1 ] && [ -d "${roots[0]}" ]; then
            mv "${roots[0]}"/* .
          else
            mv extracted/* .
          fi

      - name: Cleanup temp & remove zip
        run: |
          rm -rf extracted
          rm -f "${ZIP_PATH}"

      - name: Show top-level tree
        run: ls -la

      - name: Commit extracted files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: extract ${ZIP_PATH} into repo"
          commit_user_name: Azbry-Bot
          commit_user_email: bot@azbry.dev
          push_options: --force-with-lease
